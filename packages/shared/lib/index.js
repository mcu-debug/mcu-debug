"use strict";var v=Object.create;var f=Object.defineProperty;var K=Object.getOwnPropertyDescriptor;var H=Object.getOwnPropertyNames;var U=Object.getPrototypeOf,F=Object.prototype.hasOwnProperty;var L=(r,e)=>{for(var t in e)f(r,t,{get:e[t],enumerable:!0})},k=(r,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of H(e))!F.call(r,o)&&o!==t&&f(r,o,{get:()=>e[o],enumerable:!(n=K(e,o))||n.enumerable});return r};var c=(r,e,t)=>(t=r!=null?v(U(r)):{},k(e||!r||!r.__esModule?f(t,"default",{value:r,enumerable:!0}):t,r)),N=r=>k(f({},"__esModule",{value:!0}),r);var D={};L(D,{TcpPortScanner:()=>d,ValueHandleRegistry:()=>g,ValueHandleRegistryPrimitive:()=>T,commandExists:()=>V,findAvailablePortRange:()=>j});module.exports=N(D);var h=c(require("fs")),P=c(require("path")),w=c(require("os")),S=c(require("net")),b=c(require("proper-lockfile")),O=require("events"),p=class{constructor(e,t){this.lockPaths=e;this.ports=t}async release(){await Promise.all(this.lockPaths.map(e=>b.unlock(e).catch(()=>{})))}},I=[],d=class r{static LoopbackAddr="127.0.0.1";static AllInterfaces="0.0.0.0";static PortAllocated=new O.EventEmitter;static AvoidPorts=new Set;static EmitAllocated(e){if(e&&e.length){for(let t of e)r.AvoidPorts.add(t);r.PortAllocated.emit("allocated",e)}}static async isPortInUse(e,t,n){if(t&&t.has(e))return!0;let o=n&&n.length?n:[r.LoopbackAddr,r.AllInterfaces];for(let s of o)if(await r.checkPortStatus(e,s))return!0;return!1}static checkPortStatus(e,t){return new Promise((n,o)=>{let s=S.createServer(()=>{});s.once("error",a=>{a.code==="EADDRINUSE"?n(!0):o(a)}),s.once("close",()=>{n(!1)}),s.listen(e,t,()=>{s.close()})})}static findFreePorts(e,t={}){return new Promise((n,o)=>{j(e,t.start??3e4,t.consecutive??!1,t.avoid).then(s=>{I.push(s),n(s.ports)}).catch(s=>{o(s)})})}};async function R(r,e,t=!1,n){let o=[],s=[],a=[];try{for(let l=0;o.length<e;l++){let i=r+l;if(i>65535)throw new Error("Out of ports");let u=P.join(w.tmpdir(),`mcu-debug-port-${i}.lock`);if(await d.isPortInUse(i,n)){if(t)throw new Error(`Port ${i} is already in use`);continue}try{h.existsSync(u)||h.writeFileSync(u,"");let m=await b.lock(u,{stale:3e4});s.push(u),a.push(m),o.push(i)}catch(m){if(t)throw m;continue}}return new p(s,o)}catch{try{await Promise.all(a.map(i=>i().catch(()=>{})))}catch(i){console.error(`Error releasing port locks: ${i.toString()}`)}return null}}async function j(r,e,t,n){for(let o=e??3e4;o<65535;o+=10){let s=await R(o,r,t,n);if(s)return s}throw new Error(`Could not find ${r} consecutive free ports`)}process.on("exit",async()=>{for(let r of I)try{await r.release()}catch{}});var y=require("fs"),x=require("path"),A=require("process");function V(r){let t=(A.env.PATH||"").split(x.delimiter),n=A.platform==="win32"?[".exe",".cmd",".bat",".sh"]:[""];for(let o of t)for(let s of n){let a=x.join(o,r+s);try{return y.accessSync(a,y.constants.F_OK|y.constants.X_OK),!0}catch{continue}}return!1}var g=class{keyToHandle=new Map;handleToObj=new Map;counter=0;addObject(e){let t=this.getKey(e),n=this.keyToHandle.get(t);return n!==void 0||(n=++this.counter,this.keyToHandle.set(t,n),this.handleToObj.set(n,e)),n}getHandle(e){let t=this.getKey(e);return this.keyToHandle.get(t)}getObject(e){return this.handleToObj.get(e)}getObjectByKey(e){let t=this.keyToHandle.get(this.getKey(e));if(t!==void 0)return this.handleToObj.get(t)}release(e){let t=this.handleToObj.get(e);if(!t)return!1;let n=this.getKey(t);return this.keyToHandle.delete(n),this.handleToObj.delete(e),!0}getKey(e){return E(e)?e.toValueKey():this.stableStringify(e)}stableStringify(e){return E(e)?e.toValueKey():e===null||typeof e!="object"?JSON.stringify(e):e instanceof Date?JSON.stringify(e.toISOString()):e instanceof RegExp?JSON.stringify(e.toString()):Array.isArray(e)?"["+e.map(o=>this.stableStringify(o)).join(",")+"]":"{"+Object.keys(e).sort().map(o=>JSON.stringify(o)+":"+this.stableStringify(e[o])).join(",")+"}"}clear(){this.keyToHandle.clear(),this.handleToObj.clear(),this.counter=0}};function E(r){return r&&typeof r.toValueKey=="function"}var T=class{keyToHandle=new Map;handleToItem=new Map;counter=0;add(e){return this.counter++,this.keyToHandle.set(e,this.counter),this.handleToItem.set(this.counter,e),this.counter}getObject(e){return this.handleToItem.get(e)}release(e){let t=this.handleToItem.get(e);return t?(this.keyToHandle.delete(t),this.handleToItem.delete(e),!0):!1}clear(){this.keyToHandle.clear(),this.handleToItem.clear(),this.counter=0}};0&&(module.exports={TcpPortScanner,ValueHandleRegistry,ValueHandleRegistryPrimitive,commandExists,findAvailablePortRange});
//# sourceMappingURL=index.js.map
