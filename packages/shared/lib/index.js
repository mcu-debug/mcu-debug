"use strict";var W=Object.create;var p=Object.defineProperty;var K=Object.getOwnPropertyDescriptor;var L=Object.getOwnPropertyNames;var M=Object.getPrototypeOf,B=Object.prototype.hasOwnProperty;var J=(e,t)=>{for(var r in t)p(e,r,{get:t[r],enumerable:!0})},I=(e,t,r,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of L(t))!B.call(e,o)&&o!==r&&p(e,o,{get:()=>t[o],enumerable:!(s=K(t,o))||s.enumerable});return e};var h=(e,t,r)=>(r=e!=null?W(M(e)):{},I(t||!e||!e.__esModule?p(r,"default",{value:e,enumerable:!0}):r,e)),q=e=>I(p({},"__esModule",{value:!0}),e);var z={};J(z,{Decoder:()=>v,TcpPortScanner:()=>f,ValueHandleRegistry:()=>w,ValueHandleRegistryPrimitive:()=>S,WaitForPort:()=>E,commandExists:()=>V,findAvailablePortRange:()=>F});module.exports=q(z);var m=h(require("fs")),A=h(require("path")),C=h(require("os")),x=h(require("net")),b=h(require("proper-lockfile")),N=require("events"),T=class{constructor(t,r){this.lockPaths=t;this.ports=r}async release(){await Promise.all(this.lockPaths.map(t=>b.unlock(t).catch(()=>{})))}},P=[],f=class e{static LoopbackAddr="127.0.0.1";static AllInterfaces="0.0.0.0";static PortAllocated=new N.EventEmitter;static AvoidPorts=new Set;static EmitAllocated(t){if(t&&t.length){for(let r of t)e.AvoidPorts.add(r);e.PortAllocated.emit("allocated",t)}}static async unlockPortsIfFree(t){for(let r of P)if(r.ports.filter(o=>t.includes(o)).length===r.ports.length)try{await r.release()}catch{}}static async isPortInUse(t,r,s){if(r&&r.has(t))return!0;let o=s&&s.length?s:[e.LoopbackAddr,e.AllInterfaces];for(let n of o)if(await e.checkPortStatus(t,n))return!0;return!1}static checkPortStatus(t,r){return new Promise((s,o)=>{let n=x.createServer(()=>{});n.once("error",i=>{i.code==="EADDRINUSE"?s(!0):o(i)}),n.once("close",()=>{s(!1)}),n.listen(t,r,()=>{n.close()})})}static findFreePorts(t,r={}){return new Promise((s,o)=>{F(t,r.start??3e4,r.consecutive??!1,r.avoid).then(n=>{P.push(n),e.EmitAllocated(n.ports),s(n.ports)}).catch(n=>{o(n)})})}};async function Q(e,t,r=!1,s){let o=[],n=[],i=[];try{for(let c=0;o.length<t;c++){let a=e+c;if(a>65535)throw new Error("Out of ports");let u=A.join(C.tmpdir(),`mcu-debug-port-${a}.lock`);if(await f.isPortInUse(a,s)){if(r)throw new Error(`Port ${a} is already in use`);continue}try{m.existsSync(u)||m.writeFileSync(u,"");let l=await b.lock(u,{stale:3e4});n.push(u),i.push(l),o.push(a)}catch(l){if(r)throw l;continue}}return new T(n,o)}catch{try{await Promise.all(i.map(a=>a().catch(()=>{})))}catch(a){console.error(`Error releasing port locks: ${a.toString()}`)}return null}}async function F(e,t,r,s){for(let o=t??3e4;o<65535;o+=10){let n=await Q(o,e,r,s);if(n)return n}throw new Error(`Could not find ${e} consecutive free ports`)}process.on("exit",async()=>{for(let e of P)try{await e.release()}catch{}});var k=require("fs"),D=require("path"),j=require("process");function V(e){let r=(j.env.PATH||"").split(D.delimiter),s=j.platform==="win32"?[".exe",".cmd",".bat",".sh"]:[""];for(let o of r)for(let n of s){let i=D.join(o,e+n);try{return k.accessSync(i,k.constants.F_OK|k.constants.X_OK),!0}catch{continue}}return!1}var w=class{keyToHandle=new Map;handleToObj=new Map;counter=0;addObject(t){let r=this.getKey(t),s=this.keyToHandle.get(r);return s!==void 0||(s=++this.counter,this.keyToHandle.set(r,s),this.handleToObj.set(s,t)),s}getHandle(t){let r=this.getKey(t);return this.keyToHandle.get(r)}getObject(t){return this.handleToObj.get(t)}getObjectByKey(t){let r=this.getKey(t),s=this.keyToHandle.get(r);if(s!==void 0)return this.handleToObj.get(s)}release(t){let r=this.handleToObj.get(t);if(!r)return!1;let s=this.getKey(r);return this.keyToHandle.delete(s),this.handleToObj.delete(t),!0}getKey(t){return $(t)?t.toValueKey():this.stableStringify(t)}stableStringify(t){return $(t)?t.toValueKey():t===null||typeof t!="object"?JSON.stringify(t):t instanceof Date?JSON.stringify(t.toISOString()):t instanceof RegExp?JSON.stringify(t.toString()):Array.isArray(t)?"["+t.map(o=>this.stableStringify(o)).join(",")+"]":"{"+Object.keys(t).sort().map(o=>JSON.stringify(o)+":"+this.stableStringify(t[o])).join(",")+"}"}clear(){this.keyToHandle.clear(),this.handleToObj.clear(),this.counter=0}};function $(e){return e&&typeof e.toValueKey=="function"}var S=class{keyToHandle=new Map;handleToItem=new Map;counter=0;add(t){let r=this.keyToHandle.get(t);return r!==void 0?r:(this.counter++,this.keyToHandle.set(t,this.counter),this.handleToItem.set(this.counter,t),this.counter)}get(t){return this.handleToItem.get(t)}release(t){let r=this.handleToItem.get(t);return r?(this.keyToHandle.delete(r),this.handleToItem.delete(t),!0):!1}clear(){this.keyToHandle.clear(),this.handleToItem.clear(),this.counter=0}};var g=h(require("net")),G={silent:{setup:()=>{},starting:()=>{},tryConnect:()=>{},connected:()=>{},timeout:()=>{}},verbose:{starting:({host:e,port:t})=>{console.log(`Waiting for ${e}:${t} to become available...`)},setup:e=>{console.log(`Socket created: ${e.remoteAddress}:${e.remotePort}`)},tryConnect:()=>{console.log("Trying to connect...")},connected:e=>{console.log("Connected!")},timeout:()=>{console.log("Timeout reached, giving up.")}}},E=class{constructor(t){this.params=t}IPv6enabled=!0;returnedSocket=!1;createConnectionWithTimeout(t,r,s){let o=null,n={host:this.params.host,port:this.params.port,family:t,autoSelectFamily:!0},i=g.createConnection(n,c=>{if(!c&&o&&(clearTimeout(o),o=null),!this.returnedSocket)return s(c)});return this.params.callbacks.setup?.(i),i.on("error",c=>{o&&(clearTimeout(o),o=null),this.returnedSocket||(i.destroy(),s(c))}),o=setTimeout(()=>{i.destroy();let c=new Error(`Timeout trying to open socket to ${this.params.host}:${this.params.port}, IPv${t}`);c.code="ECONNTIMEOUT",s(c)},r),i}checkHttp(t,r,s,o){let n=`GET ${this.params.path} HTTP/1.1\r
Host: ${this.params.host}\r
\r
`,i=null;i=setTimeout(()=>{t.destroy();let c=new Error(`Timeout waiting for data from ${this.params.host}:${this.params.port}, IPv${r}`);c.code="EREQTIMEOUT",o(c)},s),t.on("data",function(c){let u=c.toString().split(`
`)[0];i&&clearTimeout(i);let d=u.split(" ");if(d.length<2||d[1].startsWith("2")===!1){let l=new Error("Invalid response from server");l.code="ERESPONSE",o(l)}o()}),t.write(n)}tryConnect(t,r){return new Promise((s,o)=>{try{let n=this.createConnectionWithTimeout(t,this.params.interval||1e3,i=>{if(i)return i.code==="ECONNREFUSED"||i.code==="EACCES"?(n.destroy(),s([!1])):i.code==="ECONNTIMEOUT"?(n.destroy(),s([!1])):i.code==="ECONNRESET"?(n.destroy(),s([!1])):this.IPv6enabled===!0&&(i.code==="EADDRNOTAVAIL"||i.code==="ENOTFOUND")?(this.IPv6enabled=!1,n.destroy(),s([!1])):i.code==="ENOTFOUND"?(n.destroy(),this.params.waitForDns===!0?s([!1]):o(new Error(`The address '${this.params.host}' cannot be found`))):(n.destroy(),t===6?(this.IPv6enabled=!1,s([!1])):o(i));if(this.params.protocol!=="http")return s([!0,n]);this.checkHttp(n,t,r,c=>c?c.code==="EREQTIMEOUT"?(n.destroy(),s([!1])):c.code==="ERESPONSE"?(n.destroy(),s([!1])):(n.destroy(),o(c)):s([!0,n]))})}catch(n){return o(n)}})}waitPort(){return this.returnedSocket=!1,this.IPv6enabled=!0,new Promise((t,r)=>{X(this.params);let s=this.params.host,o=this.params.port,n=this.params.interval,i=this.params.timeout,c=new Date,a=1e3,u=this.params.callbacks||G.silent;u.starting({host:s,port:o});let d=(l=4)=>{u.tryConnect?.(),this.tryConnect(l,a).then(([y,O])=>{if(y)return this.returnedSocket=!0,u.connected(O),t({open:!0,ipVersion:l,socket:O});let U=new Date().getTime()-c.getTime();return i&&U>i?(u.timeout(),t({open:!1})):this.IPv6enabled&&l===4&&!g.isIP(s)?d(6):setTimeout(d,n)}).catch(y=>r(y))};d()})}};function X(e){e.protocol=e.protocol||"tcp",e.host=e.host||"127.0.0.1",e.port=e.port||80,e.path=e.path||"/",e.interval=e.interval||1e3,e.timeout=e.timeout||0,e.waitForDns=e.waitForDns||!1}var H=h(require("child_process")),R=require("events"),v=class extends R.EventEmitter{spec;process;constructor(t){super(),this.spec=Object.assign({},t),this.spec.cwd=t.cwd||process.cwd(),this.spec.env={...process.env,...t.env||{}}}getProgram(){return this.spec.program}getArgs(){return this.spec.args}getCwd(){return this.spec.cwd}runProgram(t){return new Promise((r,s)=>{let o={cwd:this.getCwd(),env:this.spec.env,detached:!0};t&&(o.stdio=t),this.process=H.spawn(this.getProgram(),this.getArgs(),o),this.process.stdout?.on("data",n=>{this.emit("stdout",n)}),this.process.stderr?.on("data",n=>{this.emit("stderr",n)}),this.process.on("close",n=>{this.emit("close",n)}),this.process.on("error",n=>{this.emit("error",n),s(n)}),this.process.on("spawn",()=>{r()}),this.on("stdin",async n=>{await this.writeStdin(n)})})}setStdinPiped(t){t.pipe(this.process?.stdin)}setStdoutPiped(t){this.process?.stdout?.pipe(t)}setStderrPiped(t){this.process?.stderr?.pipe(t)}async writeStdin(t){this.process&&this.process.stdin&&this.process.stdin.writable&&(this.process.stdin.write(t)||await this.process.stdin.once("drain",()=>{}))}close(){this.process&&(this.process.stdin?.end(),setTimeout(()=>{this.process?.stdout?.destroy(),this.process?.stderr?.destroy(),this.process?.kill(),this.process=void 0},10))}dispose(){this.close(),this.removeAllListeners()}};0&&(module.exports={Decoder,TcpPortScanner,ValueHandleRegistry,ValueHandleRegistryPrimitive,WaitForPort,commandExists,findAvailablePortRange});
//# sourceMappingURL=index.js.map
