"use strict";var j=Object.create;var h=Object.defineProperty;var R=Object.getOwnPropertyDescriptor;var U=Object.getOwnPropertyNames;var K=Object.getPrototypeOf,W=Object.prototype.hasOwnProperty;var L=(e,t)=>{for(var r in t)h(e,r,{get:t[r],enumerable:!0})},O=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of U(t))!W.call(e,o)&&o!==r&&h(e,o,{get:()=>t[o],enumerable:!(n=R(t,o))||n.enumerable});return e};var f=(e,t,r)=>(r=e!=null?j(K(e)):{},O(t||!e||!e.__esModule?h(r,"default",{value:e,enumerable:!0}):r,e)),M=e=>O(h({},"__esModule",{value:!0}),e);var V={};L(V,{TcpPortScanner:()=>m,ValueHandleRegistry:()=>P,ValueHandleRegistryPrimitive:()=>E,WaitForPort:()=>S,commandExists:()=>q,findAvailablePortRange:()=>x});module.exports=M(V);var p=f(require("fs")),v=f(require("path")),I=f(require("os")),C=f(require("net")),b=f(require("proper-lockfile")),N=require("events"),T=class{constructor(t,r){this.lockPaths=t;this.ports=r}async release(){await Promise.all(this.lockPaths.map(t=>b.unlock(t).catch(()=>{})))}},A=[],m=class e{static LoopbackAddr="127.0.0.1";static AllInterfaces="0.0.0.0";static PortAllocated=new N.EventEmitter;static AvoidPorts=new Set;static EmitAllocated(t){if(t&&t.length){for(let r of t)e.AvoidPorts.add(r);e.PortAllocated.emit("allocated",t)}}static async isPortInUse(t,r,n){if(r&&r.has(t))return!0;let o=n&&n.length?n:[e.LoopbackAddr,e.AllInterfaces];for(let s of o)if(await e.checkPortStatus(t,s))return!0;return!1}static checkPortStatus(t,r){return new Promise((n,o)=>{let s=C.createServer(()=>{});s.once("error",i=>{i.code==="EADDRINUSE"?n(!0):o(i)}),s.once("close",()=>{n(!1)}),s.listen(t,r,()=>{s.close()})})}static findFreePorts(t,r={}){return new Promise((n,o)=>{x(t,r.start??3e4,r.consecutive??!1,r.avoid).then(s=>{A.push(s),n(s.ports)}).catch(s=>{o(s)})})}};async function J(e,t,r=!1,n){let o=[],s=[],i=[];try{for(let a=0;o.length<t;a++){let c=e+a;if(c>65535)throw new Error("Out of ports");let u=v.join(I.tmpdir(),`mcu-debug-port-${c}.lock`);if(await m.isPortInUse(c,n)){if(r)throw new Error(`Port ${c} is already in use`);continue}try{p.existsSync(u)||p.writeFileSync(u,"");let l=await b.lock(u,{stale:3e4});s.push(u),i.push(l),o.push(c)}catch(l){if(r)throw l;continue}}return new T(s,o)}catch{try{await Promise.all(i.map(c=>c().catch(()=>{})))}catch(c){console.error(`Error releasing port locks: ${c.toString()}`)}return null}}async function x(e,t,r,n){for(let o=t??3e4;o<65535;o+=10){let s=await J(o,e,r,n);if(s)return s}throw new Error(`Could not find ${e} consecutive free ports`)}process.on("exit",async()=>{for(let e of A)try{await e.release()}catch{}});var k=require("fs"),F=require("path"),$=require("process");function q(e){let r=($.env.PATH||"").split(F.delimiter),n=$.platform==="win32"?[".exe",".cmd",".bat",".sh"]:[""];for(let o of r)for(let s of n){let i=F.join(o,e+s);try{return k.accessSync(i,k.constants.F_OK|k.constants.X_OK),!0}catch{continue}}return!1}var P=class{keyToHandle=new Map;handleToObj=new Map;counter=0;addObject(t){let r=this.getKey(t),n=this.keyToHandle.get(r);return n!==void 0||(n=++this.counter,this.keyToHandle.set(r,n),this.handleToObj.set(n,t)),n}getHandle(t){let r=this.getKey(t);return this.keyToHandle.get(r)}getObject(t){return this.handleToObj.get(t)}getObjectByKey(t){let r=this.getKey(t),n=this.keyToHandle.get(r);if(n!==void 0)return this.handleToObj.get(n)}release(t){let r=this.handleToObj.get(t);if(!r)return!1;let n=this.getKey(r);return this.keyToHandle.delete(n),this.handleToObj.delete(t),!0}getKey(t){return D(t)?t.toValueKey():this.stableStringify(t)}stableStringify(t){return D(t)?t.toValueKey():t===null||typeof t!="object"?JSON.stringify(t):t instanceof Date?JSON.stringify(t.toISOString()):t instanceof RegExp?JSON.stringify(t.toString()):Array.isArray(t)?"["+t.map(o=>this.stableStringify(o)).join(",")+"]":"{"+Object.keys(t).sort().map(o=>JSON.stringify(o)+":"+this.stableStringify(t[o])).join(",")+"}"}clear(){this.keyToHandle.clear(),this.handleToObj.clear(),this.counter=0}};function D(e){return e&&typeof e.toValueKey=="function"}var E=class{keyToHandle=new Map;handleToItem=new Map;counter=0;add(t){let r=this.keyToHandle.get(t);return r!==void 0?r:(this.counter++,this.keyToHandle.set(t,this.counter),this.handleToItem.set(this.counter,t),this.counter)}get(t){return this.handleToItem.get(t)}release(t){let r=this.handleToItem.get(t);return r?(this.keyToHandle.delete(r),this.handleToItem.delete(t),!0):!1}clear(){this.keyToHandle.clear(),this.handleToItem.clear(),this.counter=0}};var y=f(require("net")),B={silent:{setup:()=>{},starting:()=>{},tryConnect:()=>{},connected:()=>{},timeout:()=>{}},verbose:{starting:({host:e,port:t})=>{console.log(`Waiting for ${e}:${t} to become available...`)},setup:e=>{console.log(`Socket created: ${e.remoteAddress}:${e.remotePort}`)},tryConnect:()=>{console.log("Trying to connect...")},connected:e=>{console.log("Connected!")},timeout:()=>{console.log("Timeout reached, giving up.")}}},S=class{constructor(t){this.params=t}IPv6enabled=!0;returnedSocket=!1;createConnectionWithTimeout(t,r,n){let o=null,s={host:this.params.host,port:this.params.port,family:t,autoSelectFamily:!0},i=y.createConnection(s,a=>{if(!a&&o&&(clearTimeout(o),o=null),!this.returnedSocket)return n(a)});return this.params.callbacks.setup?.(i),i.on("error",a=>{o&&(clearTimeout(o),o=null),this.returnedSocket||(i.destroy(),n(a))}),o=setTimeout(()=>{i.destroy();let a=new Error(`Timeout trying to open socket to ${this.params.host}:${this.params.port}, IPv${t}`);a.code="ECONNTIMEOUT",n(a)},r),i}checkHttp(t,r,n,o){let s=`GET ${this.params.path} HTTP/1.1\r
Host: ${this.params.host}\r
\r
`,i=null;i=setTimeout(()=>{t.destroy();let a=new Error(`Timeout waiting for data from ${this.params.host}:${this.params.port}, IPv${r}`);a.code="EREQTIMEOUT",o(a)},n),t.on("data",function(a){let u=a.toString().split(`
`)[0];i&&clearTimeout(i);let d=u.split(" ");if(d.length<2||d[1].startsWith("2")===!1){let l=new Error("Invalid response from server");l.code="ERESPONSE",o(l)}o()}),t.write(s)}tryConnect(t,r){return new Promise((n,o)=>{try{let s=this.createConnectionWithTimeout(t,this.params.interval||1e3,i=>{if(i)return i.code==="ECONNREFUSED"||i.code==="EACCES"?(s.destroy(),n([!1])):i.code==="ECONNTIMEOUT"?(s.destroy(),n([!1])):i.code==="ECONNRESET"?(s.destroy(),n([!1])):this.IPv6enabled===!0&&(i.code==="EADDRNOTAVAIL"||i.code==="ENOTFOUND")?(this.IPv6enabled=!1,s.destroy(),n([!1])):i.code==="ENOTFOUND"?(s.destroy(),this.params.waitForDns===!0?n([!1]):o(new Error(`The address '${this.params.host}' cannot be found`))):(s.destroy(),t===6?(this.IPv6enabled=!1,n([!1])):o(i));if(this.params.protocol!=="http")return n([!0,s]);this.checkHttp(s,t,r,a=>a?a.code==="EREQTIMEOUT"?(s.destroy(),n([!1])):a.code==="ERESPONSE"?(s.destroy(),n([!1])):(s.destroy(),o(a)):n([!0,s]))})}catch(s){return o(s)}})}waitPort(){return this.returnedSocket=!1,this.IPv6enabled=!0,new Promise((t,r)=>{Q(this.params);let n=this.params.host,o=this.params.port,s=this.params.interval,i=this.params.timeout,a=new Date,c=1e3,u=this.params.callbacks||B.silent;u.starting({host:n,port:o});let d=(l=4)=>{u.tryConnect?.(),this.tryConnect(l,c).then(([g,w])=>{if(g)return this.returnedSocket=!0,u.connected(w),t({open:!0,ipVersion:l,socket:w});let H=new Date().getTime()-a.getTime();return i&&H>i?(u.timeout(),t({open:!1})):this.IPv6enabled&&l===4&&!y.isIP(n)?d(6):setTimeout(d,s)}).catch(g=>r(g))};d()})}};function Q(e){e.protocol=e.protocol||"tcp",e.host=e.host||"127.0.0.1",e.port=e.port||80,e.path=e.path||"/",e.interval=e.interval||1e3,e.timeout=e.timeout||0,e.waitForDns=e.waitForDns||!1}0&&(module.exports={TcpPortScanner,ValueHandleRegistry,ValueHandleRegistryPrimitive,WaitForPort,commandExists,findAvailablePortRange});
//# sourceMappingURL=index.js.map
