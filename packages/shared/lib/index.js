"use strict";var A=Object.create;var f=Object.defineProperty;var K=Object.getOwnPropertyDescriptor;var E=Object.getOwnPropertyNames;var H=Object.getPrototypeOf,v=Object.prototype.hasOwnProperty;var F=(n,e)=>{for(var t in e)f(n,t,{get:e[t],enumerable:!0})},g=(n,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of E(e))!v.call(n,i)&&i!==t&&f(n,i,{get:()=>e[i],enumerable:!(r=K(e,i))||r.enumerable});return n};var c=(n,e,t)=>(t=n!=null?A(H(n)):{},g(e||!n||!n.__esModule?f(t,"default",{value:n,enumerable:!0}):t,n)),N=n=>g(f({},"__esModule",{value:!0}),n);var V={};F(V,{TcpPortScanner:()=>d,ValueHandleRegistry:()=>p,ValueHandleRegistryPrimitive:()=>y,commandExists:()=>U,findAvailablePortRange:()=>S});module.exports=N(V);var h=c(require("fs")),T=c(require("path")),k=c(require("os")),P=c(require("net")),l=c(require("proper-lockfile")),w=require("events"),b=class{constructor(e,t){this.lockPaths=e;this.ports=t}async release(){await Promise.all(this.lockPaths.map(e=>l.unlock(e).catch(()=>{})))}},O=[],d=class n{static LoopbackAddr="127.0.0.1";static AllInterfaces="0.0.0.0";static PortAllocated=new w.EventEmitter;static AvoidPorts=new Set;static EmitAllocated(e){if(e&&e.length){for(let t of e)n.AvoidPorts.add(t);n.PortAllocated.emit("allocated",e)}}static isPortInUse(e,t){return new Promise((r,i)=>{if(t&&t.has(e)){r(!0);return}let s=P.createServer();s.once("error",o=>{o.code==="EADDRINUSE"?r(!0):i(o)}),s.once("listening",()=>{s.close(()=>{r(!1)})}),s.listen(e,n.AllInterfaces)})}static findFreePorts(e,t={}){return new Promise((r,i)=>{S(e,t.start??3e4,t.consecutive??!1,t.avoid).then(s=>{O.push(s),r(s.ports)}).catch(s=>{i(s)})})}};async function R(n,e,t=!1,r){let i=[],s=[];try{for(let o=0;s.length<e;o++){let a=n+o,u=T.join(k.tmpdir(),`mcu-debug-port-${a}.lock`);if(await d.isPortInUse(a,r)){if(t)throw new Error(`Port ${a} is already in use`);continue}h.existsSync(u)||h.writeFileSync(u,""),await l.lock(u,{retries:0,stale:6e4,realpath:!1,fs:{retries:0}}),i.push(u),s.push(a)}return new b(i,s)}catch{return await Promise.all(i.map(a=>l.unlock(a).catch(()=>{}))),null}}async function S(n,e,t,r){for(let i=e??3e4;i<65535;i+=10){let s=await R(i,n,t,r);if(s)return s}throw new Error(`Could not find ${n} consecutive free ports`)}process.on("exit",async()=>{for(let n of O)try{await n.release()}catch{}});var m=require("fs"),I=require("path"),j=require("process");function U(n){let t=(j.env.PATH||"").split(I.delimiter),r=j.platform==="win32"?[".exe",".cmd",".bat",".sh"]:[""];for(let i of t)for(let s of r){let o=I.join(i,n+s);try{return m.accessSync(o,m.constants.F_OK|m.constants.X_OK),!0}catch{continue}}return!1}var p=class{keyToHandle=new Map;handleToObj=new Map;counter=0;addObject(e){let t=this.getKey(e),r=this.keyToHandle.get(t);return r!==void 0||(r=++this.counter,this.keyToHandle.set(t,r),this.handleToObj.set(r,e)),r}getHandle(e){let t=this.getKey(e);return this.keyToHandle.get(t)}getObject(e){return this.handleToObj.get(e)}getObjectByKey(e){let t=this.keyToHandle.get(this.getKey(e));if(t!==void 0)return this.handleToObj.get(t)}release(e){let t=this.handleToObj.get(e);if(!t)return!1;let r=this.getKey(t);return this.keyToHandle.delete(r),this.handleToObj.delete(e),!0}getKey(e){return x(e)?e.toValueKey():this.stableStringify(e)}stableStringify(e){return x(e)?e.toValueKey():e===null||typeof e!="object"?JSON.stringify(e):e instanceof Date?JSON.stringify(e.toISOString()):e instanceof RegExp?JSON.stringify(e.toString()):Array.isArray(e)?"["+e.map(i=>this.stableStringify(i)).join(",")+"]":"{"+Object.keys(e).sort().map(i=>JSON.stringify(i)+":"+this.stableStringify(e[i])).join(",")+"}"}clear(){this.keyToHandle.clear(),this.handleToObj.clear(),this.counter=0}};function x(n){return n&&typeof n.toValueKey=="function"}var y=class{keyToHandle=new Map;handleToItem=new Map;counter=0;add(e){return this.counter++,this.keyToHandle.set(e,this.counter),this.handleToItem.set(this.counter,e),this.counter}getObject(e){return this.handleToItem.get(e)}release(e){let t=this.handleToItem.get(e);return t?(this.keyToHandle.delete(t),this.handleToItem.delete(e),!0):!1}clear(){this.keyToHandle.clear(),this.handleToItem.clear(),this.counter=0}};0&&(module.exports={TcpPortScanner,ValueHandleRegistry,ValueHandleRegistryPrimitive,commandExists,findAvailablePortRange});
//# sourceMappingURL=index.js.map
