var b=(s=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(s,{get:(t,n)=>(typeof require<"u"?require:t)[n]}):s)(function(s){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+s+'" is not supported')});import*as h from"fs";import*as k from"path";import*as S from"os";import*as w from"net";import*as p from"proper-lockfile";import{EventEmitter as j}from"events";var g=class{constructor(t,n){this.lockPaths=t;this.ports=n}async release(){await Promise.all(this.lockPaths.map(t=>p.unlock(t).catch(()=>{})))}},E=[],y=class s{static LoopbackAddr="127.0.0.1";static AllInterfaces="0.0.0.0";static PortAllocated=new j;static AvoidPorts=new Set;static EmitAllocated(t){if(t&&t.length){for(let n of t)s.AvoidPorts.add(n);s.PortAllocated.emit("allocated",t)}}static async isPortInUse(t,n,r){if(n&&n.has(t))return!0;let o=r&&r.length?r:[s.LoopbackAddr,s.AllInterfaces];for(let e of o)if(await s.checkPortStatus(t,e))return!0;return!1}static checkPortStatus(t,n){return new Promise((r,o)=>{let e=w.createServer(()=>{});e.once("error",i=>{i.code==="EADDRINUSE"?r(!0):o(i)}),e.once("close",()=>{r(!1)}),e.listen(t,n,()=>{e.close()})})}static findFreePorts(t,n={}){return new Promise((r,o)=>{H(t,n.start??3e4,n.consecutive??!1,n.avoid).then(e=>{E.push(e),r(e.ports)}).catch(e=>{o(e)})})}};async function $(s,t,n=!1,r){let o=[],e=[],i=[];try{for(let a=0;o.length<t;a++){let c=s+a;if(c>65535)throw new Error("Out of ports");let u=k.join(S.tmpdir(),`mcu-debug-port-${c}.lock`);if(await y.isPortInUse(c,r)){if(n)throw new Error(`Port ${c} is already in use`);continue}try{h.existsSync(u)||h.writeFileSync(u,"");let l=await p.lock(u,{stale:3e4});e.push(u),i.push(l),o.push(c)}catch(l){if(n)throw l;continue}}return new g(e,o)}catch{try{await Promise.all(i.map(c=>c().catch(()=>{})))}catch(c){console.error(`Error releasing port locks: ${c.toString()}`)}return null}}async function H(s,t,n,r){for(let o=t??3e4;o<65535;o+=10){let e=await $(o,s,n,r);if(e)return e}throw new Error(`Could not find ${s} consecutive free ports`)}process.on("exit",async()=>{for(let s of E)try{await s.release()}catch{}});var T=b("fs"),v=b("path"),O=b("process");function J(s){let n=(O.env.PATH||"").split(v.delimiter),r=O.platform==="win32"?[".exe",".cmd",".bat",".sh"]:[""];for(let o of n)for(let e of r){let i=v.join(o,s+e);try{return T.accessSync(i,T.constants.F_OK|T.constants.X_OK),!0}catch{continue}}return!1}var I=class{keyToHandle=new Map;handleToObj=new Map;counter=0;addObject(t){let n=this.getKey(t),r=this.keyToHandle.get(n);return r!==void 0||(r=++this.counter,this.keyToHandle.set(n,r),this.handleToObj.set(r,t)),r}getHandle(t){let n=this.getKey(t);return this.keyToHandle.get(n)}getObject(t){return this.handleToObj.get(t)}getObjectByKey(t){let n=this.getKey(t),r=this.keyToHandle.get(n);if(r!==void 0)return this.handleToObj.get(r)}release(t){let n=this.handleToObj.get(t);if(!n)return!1;let r=this.getKey(n);return this.keyToHandle.delete(r),this.handleToObj.delete(t),!0}getKey(t){return C(t)?t.toValueKey():this.stableStringify(t)}stableStringify(t){return C(t)?t.toValueKey():t===null||typeof t!="object"?JSON.stringify(t):t instanceof Date?JSON.stringify(t.toISOString()):t instanceof RegExp?JSON.stringify(t.toString()):Array.isArray(t)?"["+t.map(o=>this.stableStringify(o)).join(",")+"]":"{"+Object.keys(t).sort().map(o=>JSON.stringify(o)+":"+this.stableStringify(t[o])).join(",")+"}"}clear(){this.keyToHandle.clear(),this.handleToObj.clear(),this.counter=0}};function C(s){return s&&typeof s.toValueKey=="function"}var x=class{keyToHandle=new Map;handleToItem=new Map;counter=0;add(t){let n=this.keyToHandle.get(t);return n!==void 0?n:(this.counter++,this.keyToHandle.set(t,this.counter),this.handleToItem.set(this.counter,t),this.counter)}get(t){return this.handleToItem.get(t)}release(t){let n=this.handleToItem.get(t);return n?(this.keyToHandle.delete(n),this.handleToItem.delete(t),!0):!1}clear(){this.keyToHandle.clear(),this.handleToItem.clear(),this.counter=0}};import*as f from"net";var R={silent:{setup:()=>{},starting:()=>{},tryConnect:()=>{},connected:()=>{},timeout:()=>{}},verbose:{starting:({host:s,port:t})=>{console.log(`Waiting for ${s}:${t} to become available...`)},setup:s=>{console.log(`Socket created: ${s.remoteAddress}:${s.remotePort}`)},tryConnect:()=>{console.log("Trying to connect...")},connected:s=>{console.log("Connected!")},timeout:()=>{console.log("Timeout reached, giving up.")}}},A=class{constructor(t){this.params=t}IPv6enabled=!0;returnedSocket=!1;createConnectionWithTimeout(t,n,r){let o=null,e={host:this.params.host,port:this.params.port,family:t,autoSelectFamily:!0},i=f.createConnection(e,a=>{if(!a&&o&&(clearTimeout(o),o=null),!this.returnedSocket)return r(a)});return this.params.callbacks.setup?.(i),i.on("error",a=>{o&&(clearTimeout(o),o=null),this.returnedSocket||(i.destroy(),r(a))}),o=setTimeout(()=>{i.destroy();let a=new Error(`Timeout trying to open socket to ${this.params.host}:${this.params.port}, IPv${t}`);a.code="ECONNTIMEOUT",r(a)},n),i}checkHttp(t,n,r,o){let e=`GET ${this.params.path} HTTP/1.1\r
Host: ${this.params.host}\r
\r
`,i=null;i=setTimeout(()=>{t.destroy();let a=new Error(`Timeout waiting for data from ${this.params.host}:${this.params.port}, IPv${n}`);a.code="EREQTIMEOUT",o(a)},r),t.on("data",function(a){let u=a.toString().split(`
`)[0];i&&clearTimeout(i);let d=u.split(" ");if(d.length<2||d[1].startsWith("2")===!1){let l=new Error("Invalid response from server");l.code="ERESPONSE",o(l)}o()}),t.write(e)}tryConnect(t,n){return new Promise((r,o)=>{try{let e=this.createConnectionWithTimeout(t,this.params.interval||1e3,i=>{if(i)return i.code==="ECONNREFUSED"||i.code==="EACCES"?(e.destroy(),r([!1])):i.code==="ECONNTIMEOUT"?(e.destroy(),r([!1])):i.code==="ECONNRESET"?(e.destroy(),r([!1])):this.IPv6enabled===!0&&(i.code==="EADDRNOTAVAIL"||i.code==="ENOTFOUND")?(this.IPv6enabled=!1,e.destroy(),r([!1])):i.code==="ENOTFOUND"?(e.destroy(),this.params.waitForDns===!0?r([!1]):o(new Error(`The address '${this.params.host}' cannot be found`))):(e.destroy(),t===6?(this.IPv6enabled=!1,r([!1])):o(i));if(this.params.protocol!=="http")return r([!0,e]);this.checkHttp(e,t,n,a=>a?a.code==="EREQTIMEOUT"?(e.destroy(),r([!1])):a.code==="ERESPONSE"?(e.destroy(),r([!1])):(e.destroy(),o(a)):r([!0,e]))})}catch(e){return o(e)}})}waitPort(){return this.returnedSocket=!1,this.IPv6enabled=!0,new Promise((t,n)=>{U(this.params);let r=this.params.host,o=this.params.port,e=this.params.interval,i=this.params.timeout,a=new Date,c=1e3,u=this.params.callbacks||R.silent;u.starting({host:r,port:o});let d=(l=4)=>{u.tryConnect?.(),this.tryConnect(l,c).then(([m,P])=>{if(m)return this.returnedSocket=!0,u.connected(P),t({open:!0,ipVersion:l,socket:P});let D=new Date().getTime()-a.getTime();return i&&D>i?(u.timeout(),t({open:!1})):this.IPv6enabled&&l===4&&!f.isIP(r)?d(6):setTimeout(d,e)}).catch(m=>n(m))};d()})}};function U(s){s.protocol=s.protocol||"tcp",s.host=s.host||"127.0.0.1",s.port=s.port||80,s.path=s.path||"/",s.interval=s.interval||1e3,s.timeout=s.timeout||0,s.waitForDns=s.waitForDns||!1}import*as F from"child_process";import{EventEmitter as W}from"events";var N=class extends W{spec;process;constructor(t){super(),this.spec=Object.assign({},t),this.spec.cwd=t.cwd||process.cwd(),this.spec.env={...process.env,...t.env||{}}}getProgram(){return this.spec.program}getArgs(){return this.spec.args}getCwd(){return this.spec.cwd}runProgram(t){return new Promise((n,r)=>{let o={cwd:this.getCwd(),env:this.spec.env,detached:!0};t&&(o.stdio=t),this.process=F.spawn(this.getProgram(),this.getArgs(),o),this.process.stdout?.on("data",e=>{this.emit("stdout",e)}),this.process.stderr?.on("data",e=>{this.emit("stderr",e)}),this.process.on("close",e=>{this.emit("close",e)}),this.process.on("error",e=>{this.emit("error",e),r(e)}),this.process.on("spawn",()=>{n()}),this.on("stdin",async e=>{await this.writeStdin(e)})})}setStdinPiped(t){t.pipe(this.process?.stdin)}setStdoutPiped(t){this.process?.stdout?.pipe(t)}setStderrPiped(t){this.process?.stderr?.pipe(t)}async writeStdin(t){this.process&&this.process.stdin&&this.process.stdin.writable&&(this.process.stdin.write(t)||await this.process.stdin.once("drain",()=>{}))}close(){this.process&&(this.process.stdin?.end(),setTimeout(()=>{this.process?.stdout?.destroy(),this.process?.stderr?.destroy(),this.process?.kill(),this.process=void 0},10))}dispose(){this.close(),this.removeAllListeners()}};export{N as Decoder,y as TcpPortScanner,I as ValueHandleRegistry,x as ValueHandleRegistryPrimitive,A as WaitForPort,J as commandExists,H as findAvailablePortRange};
//# sourceMappingURL=index.mjs.map
