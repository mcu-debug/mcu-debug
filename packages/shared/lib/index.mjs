var b=(r=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(r,{get:(t,n)=>(typeof require<"u"?require:t)[n]}):r)(function(r){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+r+'" is not supported')});import*as f from"fs";import*as P from"path";import*as E from"os";import*as S from"net";import*as h from"proper-lockfile";import{EventEmitter as F}from"events";var y=class{constructor(t,n){this.lockPaths=t;this.ports=n}async release(){await Promise.all(this.lockPaths.map(t=>h.unlock(t).catch(()=>{})))}},w=[],g=class r{static LoopbackAddr="127.0.0.1";static AllInterfaces="0.0.0.0";static PortAllocated=new F;static AvoidPorts=new Set;static EmitAllocated(t){if(t&&t.length){for(let n of t)r.AvoidPorts.add(n);r.PortAllocated.emit("allocated",t)}}static async isPortInUse(t,n,e){if(n&&n.has(t))return!0;let s=e&&e.length?e:[r.LoopbackAddr,r.AllInterfaces];for(let o of s)if(await r.checkPortStatus(t,o))return!0;return!1}static checkPortStatus(t,n){return new Promise((e,s)=>{let o=S.createServer(()=>{});o.once("error",i=>{i.code==="EADDRINUSE"?e(!0):s(i)}),o.once("close",()=>{e(!1)}),o.listen(t,n,()=>{o.close()})})}static findFreePorts(t,n={}){return new Promise((e,s)=>{D(t,n.start??3e4,n.consecutive??!1,n.avoid).then(o=>{w.push(o),e(o.ports)}).catch(o=>{s(o)})})}};async function $(r,t,n=!1,e){let s=[],o=[],i=[];try{for(let a=0;s.length<t;a++){let c=r+a;if(c>65535)throw new Error("Out of ports");let u=P.join(E.tmpdir(),`mcu-debug-port-${c}.lock`);if(await g.isPortInUse(c,e)){if(n)throw new Error(`Port ${c} is already in use`);continue}try{f.existsSync(u)||f.writeFileSync(u,"");let l=await h.lock(u,{stale:3e4});o.push(u),i.push(l),s.push(c)}catch(l){if(n)throw l;continue}}return new y(o,s)}catch{try{await Promise.all(i.map(c=>c().catch(()=>{})))}catch(c){console.error(`Error releasing port locks: ${c.toString()}`)}return null}}async function D(r,t,n,e){for(let s=t??3e4;s<65535;s+=10){let o=await $(s,r,n,e);if(o)return o}throw new Error(`Could not find ${r} consecutive free ports`)}process.on("exit",async()=>{for(let r of w)try{await r.release()}catch{}});var T=b("fs"),O=b("path"),v=b("process");function L(r){let n=(v.env.PATH||"").split(O.delimiter),e=v.platform==="win32"?[".exe",".cmd",".bat",".sh"]:[""];for(let s of n)for(let o of e){let i=O.join(s,r+o);try{return T.accessSync(i,T.constants.F_OK|T.constants.X_OK),!0}catch{continue}}return!1}var I=class{keyToHandle=new Map;handleToObj=new Map;counter=0;addObject(t){let n=this.getKey(t),e=this.keyToHandle.get(n);return e!==void 0||(e=++this.counter,this.keyToHandle.set(n,e),this.handleToObj.set(e,t)),e}getHandle(t){let n=this.getKey(t);return this.keyToHandle.get(n)}getObject(t){return this.handleToObj.get(t)}getObjectByKey(t){let n=this.getKey(t),e=this.keyToHandle.get(n);if(e!==void 0)return this.handleToObj.get(e)}release(t){let n=this.handleToObj.get(t);if(!n)return!1;let e=this.getKey(n);return this.keyToHandle.delete(e),this.handleToObj.delete(t),!0}getKey(t){return C(t)?t.toValueKey():this.stableStringify(t)}stableStringify(t){return C(t)?t.toValueKey():t===null||typeof t!="object"?JSON.stringify(t):t instanceof Date?JSON.stringify(t.toISOString()):t instanceof RegExp?JSON.stringify(t.toString()):Array.isArray(t)?"["+t.map(s=>this.stableStringify(s)).join(",")+"]":"{"+Object.keys(t).sort().map(s=>JSON.stringify(s)+":"+this.stableStringify(t[s])).join(",")+"}"}clear(){this.keyToHandle.clear(),this.handleToObj.clear(),this.counter=0}};function C(r){return r&&typeof r.toValueKey=="function"}var N=class{keyToHandle=new Map;handleToItem=new Map;counter=0;add(t){let n=this.keyToHandle.get(t);return n!==void 0?n:(this.counter++,this.keyToHandle.set(t,this.counter),this.handleToItem.set(this.counter,t),this.counter)}get(t){return this.handleToItem.get(t)}release(t){let n=this.handleToItem.get(t);return n?(this.keyToHandle.delete(n),this.handleToItem.delete(t),!0):!1}clear(){this.keyToHandle.clear(),this.handleToItem.clear(),this.counter=0}};import*as m from"net";var H={silent:{setup:()=>{},starting:()=>{},tryConnect:()=>{},connected:()=>{},timeout:()=>{}},verbose:{starting:({host:r,port:t})=>{console.log(`Waiting for ${r}:${t} to become available...`)},setup:r=>{console.log(`Socket created: ${r.remoteAddress}:${r.remotePort}`)},tryConnect:()=>{console.log("Trying to connect...")},connected:r=>{console.log("Connected!")},timeout:()=>{console.log("Timeout reached, giving up.")}}},A=class{constructor(t){this.params=t}IPv6enabled=!0;returnedSocket=!1;createConnectionWithTimeout(t,n,e){let s=null,o={host:this.params.host,port:this.params.port,family:t,autoSelectFamily:!0},i=m.createConnection(o,a=>{if(!a&&s&&(clearTimeout(s),s=null),!this.returnedSocket)return e(a)});return this.params.callbacks.setup?.(i),i.on("error",a=>{s&&(clearTimeout(s),s=null),this.returnedSocket||(i.destroy(),e(a))}),s=setTimeout(()=>{i.destroy();let a=new Error(`Timeout trying to open socket to ${this.params.host}:${this.params.port}, IPv${t}`);a.code="ECONNTIMEOUT",e(a)},n),i}checkHttp(t,n,e,s){let o=`GET ${this.params.path} HTTP/1.1\r
Host: ${this.params.host}\r
\r
`,i=null;i=setTimeout(()=>{t.destroy();let a=new Error(`Timeout waiting for data from ${this.params.host}:${this.params.port}, IPv${n}`);a.code="EREQTIMEOUT",s(a)},e),t.on("data",function(a){let u=a.toString().split(`
`)[0];i&&clearTimeout(i);let d=u.split(" ");if(d.length<2||d[1].startsWith("2")===!1){let l=new Error("Invalid response from server");l.code="ERESPONSE",s(l)}s()}),t.write(o)}tryConnect(t,n){return new Promise((e,s)=>{try{let o=this.createConnectionWithTimeout(t,this.params.interval||1e3,i=>{if(i)return i.code==="ECONNREFUSED"||i.code==="EACCES"?(o.destroy(),e([!1])):i.code==="ECONNTIMEOUT"?(o.destroy(),e([!1])):i.code==="ECONNRESET"?(o.destroy(),e([!1])):this.IPv6enabled===!0&&(i.code==="EADDRNOTAVAIL"||i.code==="ENOTFOUND")?(this.IPv6enabled=!1,o.destroy(),e([!1])):i.code==="ENOTFOUND"?(o.destroy(),this.params.waitForDns===!0?e([!1]):s(new Error(`The address '${this.params.host}' cannot be found`))):(o.destroy(),t===6?(this.IPv6enabled=!1,e([!1])):s(i));if(this.params.protocol!=="http")return e([!0,o]);this.checkHttp(o,t,n,a=>a?a.code==="EREQTIMEOUT"?(o.destroy(),e([!1])):a.code==="ERESPONSE"?(o.destroy(),e([!1])):(o.destroy(),s(a)):e([!0,o]))})}catch(o){return s(o)}})}waitPort(){return this.returnedSocket=!1,this.IPv6enabled=!0,new Promise((t,n)=>{j(this.params);let e=this.params.host,s=this.params.port,o=this.params.interval,i=this.params.timeout,a=new Date,c=1e3,u=this.params.callbacks||H.silent;u.starting({host:e,port:s});let d=(l=4)=>{u.tryConnect?.(),this.tryConnect(l,c).then(([p,k])=>{if(p)return this.returnedSocket=!0,u.connected(k),t({open:!0,ipVersion:l,socket:k});let x=new Date().getTime()-a.getTime();return i&&x>i?(u.timeout(),t({open:!1})):this.IPv6enabled&&l===4&&!m.isIP(e)?d(6):setTimeout(d,o)}).catch(p=>n(p))};d()})}};function j(r){r.protocol=r.protocol||"tcp",r.host=r.host||"127.0.0.1",r.port=r.port||80,r.path=r.path||"/",r.interval=r.interval||1e3,r.timeout=r.timeout||0,r.waitForDns=r.waitForDns||!1}export{g as TcpPortScanner,I as ValueHandleRegistry,N as ValueHandleRegistryPrimitive,A as WaitForPort,L as commandExists,D as findAvailablePortRange};
//# sourceMappingURL=index.mjs.map
