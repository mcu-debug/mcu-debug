var h=(n=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(n,{get:(e,t)=>(typeof require<"u"?require:e)[t]}):n)(function(n){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+n+'" is not supported')});import*as u from"fs";import*as y from"path";import*as g from"os";import*as T from"net";import*as f from"proper-lockfile";import{EventEmitter as x}from"events";var b=class{constructor(e,t){this.lockPaths=e;this.ports=t}async release(){await Promise.all(this.lockPaths.map(e=>f.unlock(e).catch(()=>{})))}},k=[],m=class n{static LoopbackAddr="127.0.0.1";static AllInterfaces="0.0.0.0";static PortAllocated=new x;static AvoidPorts=new Set;static EmitAllocated(e){if(e&&e.length){for(let t of e)n.AvoidPorts.add(t);n.PortAllocated.emit("allocated",e)}}static async isPortInUse(e,t,r){if(t&&t.has(e))return!0;let o=r&&r.length?r:[n.LoopbackAddr,n.AllInterfaces];for(let s of o)if(await n.checkPortStatus(e,s))return!0;return!1}static checkPortStatus(e,t){return new Promise((r,o)=>{let s=T.createServer(()=>{});s.once("error",a=>{a.code==="EADDRINUSE"?r(!0):o(a)}),s.once("close",()=>{r(!1)}),s.listen(e,t,()=>{s.close()})})}static findFreePorts(e,t={}){return new Promise((r,o)=>{A(e,t.start??3e4,t.consecutive??!1,t.avoid).then(s=>{k.push(s),r(s.ports)}).catch(s=>{o(s)})})}};async function j(n,e,t=!1,r){let o=[],s=[],a=[];try{for(let c=0;o.length<e;c++){let i=n+c;if(i>65535)throw new Error("Out of ports");let l=y.join(g.tmpdir(),`mcu-debug-port-${i}.lock`);if(await m.isPortInUse(i,r)){if(t)throw new Error(`Port ${i} is already in use`);continue}try{u.existsSync(l)||u.writeFileSync(l,"");let d=await f.lock(l,{stale:3e4});s.push(l),a.push(d),o.push(i)}catch(d){if(t)throw d;continue}}return new b(s,o)}catch{try{await Promise.all(a.map(i=>i().catch(()=>{})))}catch(i){console.error(`Error releasing port locks: ${i.toString()}`)}return null}}async function A(n,e,t,r){for(let o=e??3e4;o<65535;o+=10){let s=await j(o,n,t,r);if(s)return s}throw new Error(`Could not find ${n} consecutive free ports`)}process.on("exit",async()=>{for(let n of k)try{await n.release()}catch{}});var p=h("fs"),P=h("path"),w=h("process");function U(n){let t=(w.env.PATH||"").split(P.delimiter),r=w.platform==="win32"?[".exe",".cmd",".bat",".sh"]:[""];for(let o of t)for(let s of r){let a=P.join(o,n+s);try{return p.accessSync(a,p.constants.F_OK|p.constants.X_OK),!0}catch{continue}}return!1}var S=class{keyToHandle=new Map;handleToObj=new Map;counter=0;addObject(e){let t=this.getKey(e),r=this.keyToHandle.get(t);return r!==void 0||(r=++this.counter,this.keyToHandle.set(t,r),this.handleToObj.set(r,e)),r}getHandle(e){let t=this.getKey(e);return this.keyToHandle.get(t)}getObject(e){return this.handleToObj.get(e)}getObjectByKey(e){let t=this.keyToHandle.get(this.getKey(e));if(t!==void 0)return this.handleToObj.get(t)}release(e){let t=this.handleToObj.get(e);if(!t)return!1;let r=this.getKey(t);return this.keyToHandle.delete(r),this.handleToObj.delete(e),!0}getKey(e){return O(e)?e.toValueKey():this.stableStringify(e)}stableStringify(e){return O(e)?e.toValueKey():e===null||typeof e!="object"?JSON.stringify(e):e instanceof Date?JSON.stringify(e.toISOString()):e instanceof RegExp?JSON.stringify(e.toString()):Array.isArray(e)?"["+e.map(o=>this.stableStringify(o)).join(",")+"]":"{"+Object.keys(e).sort().map(o=>JSON.stringify(o)+":"+this.stableStringify(e[o])).join(",")+"}"}clear(){this.keyToHandle.clear(),this.handleToObj.clear(),this.counter=0}};function O(n){return n&&typeof n.toValueKey=="function"}var I=class{keyToHandle=new Map;handleToItem=new Map;counter=0;add(e){let t=this.keyToHandle.get(e);return t!==void 0?t:(this.counter++,this.keyToHandle.set(e,this.counter),this.handleToItem.set(this.counter,e),this.counter)}get(e){return this.handleToItem.get(e)}release(e){let t=this.handleToItem.get(e);return t?(this.keyToHandle.delete(t),this.handleToItem.delete(e),!0):!1}clear(){this.keyToHandle.clear(),this.handleToItem.clear(),this.counter=0}};export{m as TcpPortScanner,S as ValueHandleRegistry,I as ValueHandleRegistryPrimitive,U as commandExists,A as findAvailablePortRange};
//# sourceMappingURL=index.mjs.map
